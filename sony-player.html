<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Cloud TV Player Embed</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Plyr -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<!-- HLS -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #000;
    overflow: hidden;
}

.plyr {
    width: 100%;
    height: 100%;
}

video {
    width: 100%;
    height: 100%;
    background: #000;
}
</style>
</head>

<body>

<video id="player" playsinline muted>
    <source src="" type="application/vnd.apple.mpegurl" />
    <a href="" download>Download</a>
</video>

<!-- ✅ AUTOPLAY ENABLED SAFELY -->
<script type="application/json" id="embed-config">{
    "autoplay": true,
    "muted": true,
    "hidecontrols": false
}</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('player');
    let hasUserInteracted = false;
    let isAutoplayMuted = false;
    let autoplayAttempted = false;

    const configElement = document.getElementById('embed-config');
    const config = JSON.parse(configElement.textContent);

    const plyrOptions = {
        muted: true,
        captions: { active: true, update: true, language: 'en' }
    };

    if (config.hidecontrols) {
        plyrOptions.controls = [];
    } else {
        plyrOptions.controls = [
            'play-large',
            'play',
            'progress',
            'current-time',
            'mute',
            'volume',
            'fullscreen'
        ];
    }

    const player = new Plyr(video, plyrOptions);

    const videoUrl = '';

    /* ✅ FASTER HLS STARTUP (SAFE) */
    const hlsConfig = {
        lowLatencyMode: true,
        maxBufferLength: 15,
        maxMaxBufferLength: 30,
        backBufferLength: 30,
        enableWorker: true
    };

    let hls = null;

    if (Hls.isSupported()) {
        hls = new Hls(hlsConfig);
        hls.loadSource(videoUrl);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, function() {
            setTimeout(attemptSmartAutoplay, 50);
        });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = videoUrl;
        video.addEventListener('loadedmetadata', function() {
            setTimeout(attemptSmartAutoplay, 50);
        });
    }

    async function attemptSmartAutoplay() {
        if (autoplayAttempted) return;
        autoplayAttempted = true;

        try {
            player.muted = true;
            video.muted = true;
            await player.play();
            isAutoplayMuted = true;
        } catch (e) {
            // Autoplay blocked (rare when muted)
        }
    }

    /* Allow unmute on interaction */
    function handleInteraction() {
        if (isAutoplayMuted) {
            player.muted = false;
            video.muted = false;
            player.volume = 1;
            video.volume = 1;
            isAutoplayMuted = false;
        }
    }

    ['click','touchstart','keydown'].forEach(evt => {
        document.addEventListener(evt, handleInteraction, { once: true });
    });

});
</script>

</body>
</html>
